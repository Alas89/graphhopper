<!DOCTYPE html>
<html>
    <head>
        <title>Java Routing with GraphHopper</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="image/png" rel="icon" href="favicon.ico"/>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <script type="text/javascript" src="../js/jquery-1.7.2.min.js"></script>
        <script type="text/javascript" src="../js/dygraph-combined.js"></script>
        <script type="text/javascript">            
            $(document).ready(function(e) {
                // do not display 'nicht wohlgeformt' http://stackoverflow.com/q/335409/194609
                $.ajaxSetup({'beforeSend': function(xhr){
                        if (xhr.overrideMimeType)
                            xhr.overrideMimeType("text/plain");
                    }});
                var urls = [];
                var MAIN_URL = "/public/measurement/";
//                var MAIN_URL = "/js/";
                $.ajax({
                    type: "GET",
                    url: MAIN_URL,
                    dataType: "text",
                    success: function(allText) {
                        var allTextLines = allText.split(/"/);                        
                        var key = '.properties';
                        for (var j=0; j<allTextLines.length; j++) {
                            var line = allTextLines[j];
                            var index = line.indexOf(key);
                            if(index > 0 && index == line.length - key.length) {
                                urls.push(MAIN_URL + line);
                            }
                        }
                        console.log(urls);
                        
                        plot(urls);
                    }
                });               
            });
            
            function plot(urls) {            
                var res = [];
                var dates = [];
                for(var i = 0; i < urls.length; i++) {
                    var myurl = urls[i];
                    var index1 = myurl.indexOf("measurement");
                    var index2 = myurl.indexOf(".properties");
                    if(index1 >= 0 && index2 >= 0) {
                        var dateStr = myurl.substring(index1+11, index2);
                        var parts = dateStr.match(/(\d+)/g);
                        dates.push(new Date(parts[0], parts[1]-1, parts[2], parts[3], parts[4], parts[5]));
                    } else {
                        dates.push(new Date(0));
                    }
                    $.ajax({
                        type: "GET",
                        url: myurl,
                        dataType: "text",
                        success: function(data) {
                            var map = processProperties(data);
                            res.push(map);
                        },
                        async: false
                    });
                }
                
                console.log(dates);
                var graphKeys = ["graph", "routing", "prepare", "location2id", "measurement"];
                
                for(var graphIndex in graphKeys) {
                    var values = [];
                    var labels = ["date"];
                    var graphKey = graphKeys[graphIndex];
                    for(var i = 0; i < res.length; i++) {
                        var map = res[i];                    
                        var mainEntry = map[graphKey];
                        var arr = [dates[i]];                        
                        for(var entry in mainEntry) {                           
                            arr.push(mainEntry[entry]);
                            if(i == 0)
                                labels.push(entry);
                        }
                        values.push(arr);
                    }
                    handleGraphs($("#main"), values, graphKey, graphKey, labels);
                }
            }
            
            function processProperties(allText) {
                var allTextLines = allText.split(/\r\n|\n/);
                var result = {};
                for (var j=0; j<allTextLines.length; j++) {
                    var line = allTextLines[j];                    
                    var index = line.indexOf('=');
                    if(index > 0) {
                        var key = line.substr(0, index);
                        var value = line.substr(index + 1);
                        index = key.indexOf(".");
                        if(index > 0) {
                            var mainKey = key.substr(0, index);
                            key = key.substr(index + 1);
                            
                            var mainEntry = result[mainKey];
                            if(!mainEntry)
                                result[mainKey] = mainEntry = {};
                            
                            mainEntry[key] = value;
                        }
                    }
                }
                return result;
            }
            
            // dateHisto is an array with an object (time,count) entry
            function handleGraphs(mydiv, values, id, name, labels) {
                if(!name)
                    name = id;

                var chartDivId = id + '-chart';
                var wStr = 'width:450px;';
                var chartContainer = $('<div id="'+chartDivId+'-box" class="chart-box" style="'+
                    wStr+'"><div class="chart-header">' + name +'</div></div>');
                var chartDiv = $('<div id="'+chartDivId+'"/>').attr('style', wStr+' height:400px');
                chartContainer.append(chartDiv);
                mydiv.append(chartContainer);
                // we need getElementById here ...
                var options = {
                    labelsDivWidth: 380,
                    labelsDivStyles: {
                        'backgroundColor': 'transparent'
                    },
                    labelsSeparateLines: true,
                    labels: labels,
                    //                    xlabel: xLabels,
                    colors:['#2da8b0']
                };

                new Dygraph(document.getElementById(chartDivId), values, options);
            }
        </script>
    </head>
    <body>
        <div id="main">            
        </div>        
    </body>
</html>